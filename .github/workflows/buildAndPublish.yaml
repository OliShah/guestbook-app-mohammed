name: Build-and-Push

on:
  workflow_dispatch:
  push:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - uses: actions/checkout@v4

      - name: Install Podman
        run: |
          sudo apt-get update
          sudo apt-get install -y podman

      - name: GHCR Login
        env:
          GHCR_PAT: ${{secrets.PODMAN_GCHR_PAT}}
        run: |
          podman login ghcr.io \
            -u ${{ github.actor }} \
            -p $GHCR_PAT

      - name: Backend Build + Push
        env:
          REPO_OWNER: olishah
          IMAGE_TAG: ${{ github.sha }}
        run: |
          podman build \
          -t ghcr.io/$REPO_OWNER/backend-container:$IMAGE_TAG \
          -t ghcr.io/$REPO_OWNER/backend-container:latest \
          -f app/backend/Containerfile \
          app/backend

          podman push ghcr.io/$REPO_OWNER/backend-container:$IMAGE_TAG
          podman push ghcr.io/$REPO_OWNER/backend-container:latest

      - name: Frontend Build + Push
        env:
          REPO_OWNER: olishah
          IMAGE_TAG: ${{ github.sha }}
        run: |
          podman build \
          -t ghcr.io/$REPO_OWNER/frontend-container:$IMAGE_TAG \
          -t ghcr.io/$REPO_OWNER/frontend-container:latest \
          -f app/frontend/Containerfile \
          app/frontend
          
          podman push ghcr.io/$REPO_OWNER/frontend-container:$IMAGE_TAG
          podman push ghcr.io/$REPO_OWNER/frontend-container:latest

      - name: Redis Build + Push
        env:
          REPO_OWNER: olishah
          IMAGE_TAG: ${{ github.sha }}
        run: |
          podman build \
          -t ghcr.io/$REPO_OWNER/redis-container:$IMAGE_TAG \
          -t ghcr.io/$REPO_OWNER/redis-container:latest \
          -f app/backend/redis/Containerfile \
          app/backend
          
          podman push ghcr.io/$REPO_OWNER/redis-container:$IMAGE_TAG
          podman push ghcr.io/$REPO_OWNER/redis-container:latest

      - name: Postgres Build + Push
        env:
          REPO_OWNER: olishah
          IMAGE_TAG: ${{ github.sha }}
        run: |
          podman build \
          -t ghcr.io/$REPO_OWNER/postgres-container:$IMAGE_TAG \
          -t ghcr.io/$REPO_OWNER/postgres-container:latest \
          -f app/backend/postgresql/Containerfile \
          app/backend

          podman push ghcr.io/$REPO_OWNER/postgres-container:$IMAGE_TAG
          podman push ghcr.io/$REPO_OWNER/postgres-container:latest

      - name: Update Infra Repo
        env:
          INFRA_TOKEN: ${{ secrets.INFRA_REPO_PAT }}
          IMAGE_TAG: ${{ github.sha }}
          REPO_OWNER: olishah
          INFRA_REPO: OliShah/guestbook-infra-mohammed
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          git clone https://x-access-token:$INFRA_TOKEN@github.com/$INFRA_REPO.git infra
          cd infra
          
          # Update image tags in your k8s manifests
          # Adjust the paths and filenames to match your infra repo structure
          sed -i "s|ghcr.io/$REPO_OWNER/backend-container:.*|ghcr.io/$REPO_OWNER/backend-container:$IMAGE_TAG|g" k8s/backend-deployment.yaml
          sed -i "s|ghcr.io/$REPO_OWNER/frontend-container:.*|ghcr.io/$REPO_OWNER/frontend-container:$IMAGE_TAG|g" k8s/frontend-deployment.yaml
          sed -i "s|ghcr.io/$REPO_OWNER/redis-container:.*|ghcr.io/$REPO_OWNER/redis-container:$IMAGE_TAG|g" k8s/redis-statefulSet.yaml
          sed -i "s|ghcr.io/$REPO_OWNER/postgres-container:.*|ghcr.io/$REPO_OWNER/postgres-container:$IMAGE_TAG|g" k8s/postgres-statefulSet.yaml
          
          # Commit and push if there are changes
          if [[ -n $(git status -s) ]]; then
            git add .
            git commit -m "Update images to $IMAGE_TAG"
            git push
          else
            echo "No changes to commit"
          fi
